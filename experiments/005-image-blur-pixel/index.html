<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Blur</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.11.3/lib/p5.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #fff;
    --surface: #fff;
    --surface2: #fff;
    --border: blue;
    --text: blue;
    --text-dim: rgba(0,0,255,0.8);
    --accent: blue;
    --accent-dim: rgba(0,0,255,0.8);
    --glow: rgba(0, 0, 255, 0.08);
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-wrap: wrap;
  }

  #topbar {
    width: 100%;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    position: fixed;
    font-size: 14px;
    flex-shrink: 0;
    z-index: 1;
  }
  #topbar a {
    color: var(--text);
    text-decoration: none;
  }
  #topbar a:hover { text-decoration: underline; }
  #topbar span { flex: 1; }
  #title { text-transform: uppercase; }
  #save-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    padding: 4px 10px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  #save-btn:hover { background: var(--border); color: var(--bg); }

  #canvas-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  #canvas-wrap canvas {
    border-radius: 4px;
  }

  .panel {
    width: 360px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    height: 100vh;
    overflow-y: auto;
    padding: 28px 24px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .panel::-webkit-scrollbar { width: 4px; }
  .panel::-webkit-scrollbar-track { background: transparent; }
  .panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .panel-title {
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 20px;
  }

  .section-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--accent-dim);
    margin-top: 16px;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
  }

  .control-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .control-row label {
    font-size: 12px;
    color: var(--text-dim);
    min-width: 90px;
  }

  .control-row .value-display {
    font-size: 12px;
    color: var(--accent);
    min-width: 50px;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    flex: 1;
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
    margin: 0 10px;
    cursor: pointer;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid var(--bg);
    cursor: pointer;
    transition: transform 0.15s ease;
  }

  input[type="range"]::-webkit-slider-thumb:hover {
    transform: scale(1.2);
  }

  input[type="range"]::-moz-range-thumb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid var(--bg);
    cursor: pointer;
  }

  .btn-row {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .btn {
    flex: 1;
    padding: 10px 0;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn:hover {
    background: var(--border);
    border-color: var(--accent-dim);
    color: var(--bg);
  }

  .btn.primary {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--bg);
  }

  .btn.primary:hover {
    background: var(--accent);
  }

  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: 4px;
    padding: 24px 16px;
    text-align: center;
    font-size: 11px;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 8px;
  }

  .drop-zone:hover {
    background: var(--glow);
  }

  .drop-zone.has-image {
    border-style: solid;
    padding: 8px 16px;
  }

  #file-input {
    display: none;
  }

  .info-line {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: auto;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    line-height: 1.6;
  }

  @media (max-width: 800px) {
    body { flex-direction: column; }
    .panel {
      width: 100%;
      height: auto;
      border-left: none;
      border-top: 1px solid var(--border);
      max-height: 45vh;
    }
    #canvas-wrap { min-height: 55vh; }
  }
</style>
</head>
<body>

<div id="topbar">
  <a href="../../">‚Üê lab</a>
  <span id="title">Image Blur</span>
  <button id="save-btn" onclick="saveCanvas('pixelated', 'png')">save png</button>
</div>

<div id="canvas-wrap"></div>

<div class="panel">
  <div class="section-label">Image</div>
  <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
    Click to load image
  </div>
  <input type="file" id="file-input" accept="image/*">

  <div class="section-label">Blur</div>
  <div class="control-row">
    <label>amount</label>
    <input type="range" id="blur" min="0" max="30" step="1" value="5">
    <span class="value-display" id="blur-val">5</span>
  </div>

  <div class="section-label">Pixelation</div>
  <div class="control-row">
    <label>pixel size</label>
    <input type="range" id="pixelSize" min="2" max="128" step="1" value="16">
    <span class="value-display" id="pixelSize-val">16</span>
  </div>

  <div class="btn-row">
    <button class="btn primary" onclick="pixelate()">Redraw</button>
    <button class="btn" onclick="saveCanvas('pixelated', 'png')">Save PNG</button>
  </div>

  <div class="info-line">
    Load an image, apply blur, then pixelate by sampling average colors into square cells.
  </div>
</div>

<script>
let img = null;
let blurBuffer = null;

function getVal(id) { return parseFloat(document.getElementById(id).value); }

function updateDisplay(id) {
  document.getElementById(id + '-val').textContent = Math.round(getVal(id));
}

// Slider listeners
document.querySelectorAll('input[type="range"]').forEach(input => {
  input.addEventListener('input', () => updateDisplay(input.id));
  input.addEventListener('change', () => pixelate());
});

// File input
document.getElementById('file-input').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  loadImage(url, function(loadedImg) {
    img = loadedImg;
    document.getElementById('drop-zone').textContent = file.name;
    document.getElementById('drop-zone').classList.add('has-image');
    pixelate();
  });
});

function setup() {
  const wrap = document.getElementById('canvas-wrap');
  const cnv = createCanvas(wrap.clientWidth - 20, wrap.clientHeight - 20);
  cnv.parent('canvas-wrap');
  noLoop();
  background(255);
}

function pixelate() {
  if (!img) return;

  const blurAmt = getVal('blur');
  const pxSize = getVal('pixelSize');

  // Fit image into available canvas area (cover-style)
  const wrap = document.getElementById('canvas-wrap');
  const maxW = wrap.clientWidth - 20;
  const maxH = wrap.clientHeight - 20;
  const scale = Math.min(maxW / img.width, maxH / img.height);
  const fitW = Math.floor(img.width * scale);
  const fitH = Math.floor(img.height * scale);

  // How many whole cells fit in the scaled size
  const cols = Math.floor(fitW / pxSize);
  const rows = Math.floor(fitH / pxSize);
  if (cols < 1 || rows < 1) return;

  const outW = cols * pxSize;
  const outH = rows * pxSize;

  // Resize canvas to match pixel grid
  resizeCanvas(outW, outH);

  // Create offscreen buffer at scaled size, apply blur
  blurBuffer = createGraphics(fitW, fitH);
  blurBuffer.pixelDensity(1);
  if (blurAmt > 0) {
    blurBuffer.drawingContext.filter = 'blur(' + blurAmt + 'px)';
  }
  blurBuffer.image(img, 0, 0, fitW, fitH);
  blurBuffer.loadPixels();

  // Sample center of each cell and draw rect
  noStroke();
  for (let row = 0; row < rows; row++) {
    for (let col = 0; col < cols; col++) {
      const sx = Math.floor(col * pxSize + pxSize / 2);
      const sy = Math.floor(row * pxSize + pxSize / 2);
      const idx = (sy * blurBuffer.width + sx) * 4;
      const r = blurBuffer.pixels[idx];
      const g = blurBuffer.pixels[idx + 1];
      const b = blurBuffer.pixels[idx + 2];

      fill(r, g, b);
      rect(col * pxSize, row * pxSize, pxSize, pxSize);
    }
  }

  blurBuffer.remove();
}

function windowResized() {
  if (!img) {
    const wrap = document.getElementById('canvas-wrap');
    resizeCanvas(wrap.clientWidth - 20, wrap.clientHeight - 20);
  }
}
</script>
</body>
</html>
